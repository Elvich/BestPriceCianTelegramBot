"""
Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ† Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ….
Ð—Ð°Ð¿ÑƒÑÐºÐ°Ð¹Ñ‚Ðµ ÑÑ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¿ÐµÑ€ÐµÐ´ Ð¿ÐµÑ€Ð²Ñ‹Ð¼ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°.
"""

import asyncio
import sys
import os

# Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¿ÑƒÑ‚ÑŒ Ðº ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from DB.Models import Base, engine
from config import config

async def create_tables():
    """Ð¡Ð¾Ð·Ð´Ð°ÐµÑ‚ Ð²ÑÐµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…"""
    try:
        print("ðŸ”§ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…...")
        print(f"   Database URL: {config.DATABASE_URL}")
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²ÑÐµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹
        async with engine.begin() as conn:
            await conn.run_sync(Base.metadata.create_all)
        
        print("âœ… Ð¢Ð°Ð±Ð»Ð¸Ñ†Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹!")
        print("\nÐ¡Ð¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹:")
        print("   - apartments (Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð¸Ñ Ð¾ ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€Ð°Ñ…)")
        print("   - metro_stations (ÑÑ‚Ð°Ð½Ñ†Ð¸Ð¸ Ð¼ÐµÑ‚Ñ€Ð¾)")
        print("   - price_history (Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ñ†ÐµÐ½)")
        print("   - users (Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð±Ð¾Ñ‚Ð°)")
        print("   - expenses (ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ°Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°)")
        
    except Exception as e:
        print(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ†: {e}")
        sys.exit(1)
    finally:
        await engine.dispose()

async def drop_tables():
    """Ð£Ð´Ð°Ð»ÑÐµÑ‚ Ð²ÑÐµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ (Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð¶Ð½Ð¾!)"""
    try:
        print("âš ï¸  Ð’ÐÐ˜ÐœÐÐÐ˜Ð•: Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð²ÑÐµÑ… Ñ‚Ð°Ð±Ð»Ð¸Ñ†...")
        response = input("Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹? Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ 'yes' Ð´Ð»Ñ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ: ")
        
        if response.lower() != 'yes':
            print("ÐžÐ¿ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð°.")
            return
        
        async with engine.begin() as conn:
            await conn.run_sync(Base.metadata.drop_all)
        
        print("âœ… Ð¢Ð°Ð±Ð»Ð¸Ñ†Ñ‹ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹!")
        
    except Exception as e:
        print(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ†: {e}")
        sys.exit(1)
    finally:
        await engine.dispose()

if __name__ == "__main__":
    if len(sys.argv) > 1 and sys.argv[1] == "drop":
        asyncio.run(drop_tables())
    else:
        asyncio.run(create_tables())